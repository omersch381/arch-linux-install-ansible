---
- name: Clone yay
  git:
    repo: https://aur.archlinux.org/yay.git
    dest: /opt/yay

- name: Ensure permissions
  file:
    path: /opt/yay
    state: directory
    owner: "{{ username }}"

- name: Ensure base-devel is installed
  pacman:
    name: base-devel
    state: latest

- name: Install yay
  become: yes
  become_user: "{{ username }}"
  shell:
    chdir: /opt/yay
    cmd: makepkg -si --needed --noconfirm

- name: Remove b43-firmware from packages in case it is not required
  become: true
  become_user: root
  block:
    - name: Verify if b43-firmware is in dmesg
      become: true
      become_user: root
      shell:
        cmd: /usr/bin/dmesg | grep b43
      register: is_b43_required

    - debug:
        var: is_b43_required

    - name: remove b43-firmware packages in case it isn't in dmesg
      lineinfile:
        path: /home/{{ username }}/.config/yay/packages
        state: absent
        regexp: 'b43'
      when: is_b43_required == ''

- name: Install aur packages
  become: yes
  shell: "yay -S --needed --noconfirm - < /home/{{ username }}/.config/yay/packages"

- name: Ensure yay packages are documented in .confing/yay directory by a cron job
  ansible.builtin.cron:
    name: Ensure yay packages are documented in .confing/yay directory
    job: /usr/bin/yay -Qe | awk '{ print $1 }' > /home/omer/.config/yay/packages
    minute: "0"
    hour: "0"
    user: root
    weekday: "*"
    state: present

- name: Install a crontab job which lists the yay packages as a yay dotfile
  ansible.builtin.cron:
    name: Push list yay packages as a yay dotfile
    job: "/usr/bin/yay -Qe | awk '{ print $1 }' > /home/omer/.config/yay/packages"
    minute: "0"
    hour: "0"
    user: root
    weekday: "*"
    state: present
